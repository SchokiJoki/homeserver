version: "3.9"

networks:
  proxy:
    external: true

services:
  db:
    image: mariadb:10.11
    container_name: passbolt-db
    restart: unless-stopped
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "true"
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
    volumes:
      - ./internals/passbolt/db:/var/lib/mysql
    networks:
      - proxy

  passbolt:
    image: passbolt/passbolt:latest-ce
    container_name: passbolt
    restart: unless-stopped
    depends_on:
      - db
    networks:
      - proxy
    environment:
      APP_FULL_BASE_URL: "${APP_FULL_BASE_URL}"
      DATASOURCES_DEFAULT_HOST: "db"
      DATASOURCES_DEFAULT_USERNAME: "${MYSQL_USER}"
      DATASOURCES_DEFAULT_PASSWORD: "${MYSQL_PASSWORD}"
      DATASOURCES_DEFAULT_DATABASE: "${MYSQL_DATABASE}"

    volumes:
      - ./internals/passbolt/gpg:/etc/passbolt/gpg
      - ./internals/passbolt/jwt:/etc/passbolt/jwt

    command:
      [
        "/usr/bin/wait-for.sh",
        "-t", "0",
        "db:3306",
        "--",
        "/docker-entrypoint.sh"
      ]

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.passbolt.rule=Host(`passbolt.home`)"
      - "traefik.http.routers.passbolt.entrypoints=websecure"
      - "traefik.http.routers.passbolt.tls=true"
      - "traefik.http.routers.passbolt.service=passbolt-svc"
      - "traefik.http.services.passbolt-svc.loadbalancer.server.port=80"
      - "traefik.http.routers.passbolt.middlewares=SslHeader@file"
      - "traefik.docker.network=proxy"
