networks:
  proxy:
    external: true

services:
  passbolt-db:
    image: mariadb:10.11@sha256:3a7d3cbc8b6fddf66433d80dc124c1e4e75a73ebab9c6e137529cc270bdadfc0  # version 10.11
    container_name: passbolt-db
    restart: unless-stopped
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "true"
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
    volumes:
      - ./internals/passbolt/db:/var/lib/mysql
    networks:
      - proxy

  passbolt:
    image: passbolt/passbolt:5.6.1-1-ce@sha256:c192961f0c58618b7708078292f58e0ddba93eedac86bbd536f93846c3fbabca  # version 5.6.1-1-ce (was latest-ce)
    container_name: passbolt
    restart: unless-stopped
    depends_on:
      - passbolt-db
    networks:
      - proxy
    environment:
      APP_FULL_BASE_URL: "${APP_FULL_BASE_URL}"
      DATASOURCES_DEFAULT_HOST: "passbolt-db"
      DATASOURCES_DEFAULT_USERNAME: "${MYSQL_USER}"
      DATASOURCES_DEFAULT_PASSWORD: "${MYSQL_PASSWORD}"
      DATASOURCES_DEFAULT_DATABASE: "${MYSQL_DATABASE}"

      # E-Mail Einstellungen
      EMAIL_DEFAULT_FROM_NAME: "Passbolt"
      EMAIL_DEFAULT_FROM: "johannes.kigele@mailbox.org"

      EMAIL_TRANSPORT_DEFAULT_HOST: "smtp.mailbox.org"
      EMAIL_TRANSPORT_DEFAULT_PORT: "587"
      EMAIL_TRANSPORT_DEFAULT_USERNAME: "${MAIL_USER}"
      EMAIL_TRANSPORT_DEFAULT_PASSWORD: "${MAIL_PW}"
      EMAIL_TRANSPORT_DEFAULT_TLS: "true"

  # Weitere Passbolt typische Variablen (falls ben√∂tigt)
  # (z. B. Datenbank, Zertifikate, etc.)
    volumes:
      - ./internals/passbolt/gpg:/etc/passbolt/gpg
      - ./internals/passbolt/jwt:/etc/passbolt/jwt

    command:
      [
        "/usr/bin/wait-for.sh",
        "-t", "0",
        "passbolt-db:3306",
        "--",
        "/docker-entrypoint.sh"
      ]

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.passbolt.rule=Host(`passbolt.home`)"
      - "traefik.http.routers.passbolt.entrypoints=websecure"
      - "traefik.http.routers.passbolt.tls=true"
      - "traefik.http.routers.passbolt.service=passbolt-svc"
      - "traefik.http.services.passbolt-svc.loadbalancer.server.port=80"
      - "traefik.http.routers.passbolt.middlewares=SslHeader@file"
      - "traefik.docker.network=proxy"
