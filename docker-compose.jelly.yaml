services:
  backup-mount-guard-jelly:
    image: busybox:1.36
    container_name: backup-mount-guard-jelly
    restart: unless-stopped
    command:
      - sh
      - -c
      - "while true; do sleep 300; done"
    volumes:
      - /srv/backup/A/:/mnt/backup:ro
    healthcheck:
      test:
        - CMD-SHELL
        - test -f /mnt/backup/.mounted
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    network_mode: none

  jellyfin:
    image: jellyfin/jellyfin:latest #10.11.2@sha256:298fceb9fa1c526d1392fef62e99b903148527ed7cdb9845509bdb8c5959b366  # version 10.11.2 (was latest)
    container_name: jellyfin
    hostname: jellyfin
    networks:
      - proxy
    restart: unless-stopped
    depends_on:
      backup-mount-guard-jelly:
        condition: service_healthy
    environment:
      - TZ=Europe/Berlin
      - PUID=1000
      - PGID=1000
    volumes:
      # Konfiguration & Cache
      - /srv/backup/A/media/jellyfin/config:/config
      - /srv/backup/A/media/jellyfin/cache:/cache

      # Medienbibliotheken
      - /srv/backup/A/media/videos:/media/videos
      - /srv/backup/A/media/music:/media/music
      - /srv/backup/A/media/itunes:/media/itunes
      - /srv/backup/A/:/mnt/backup:ro
    healthcheck:
      test:
        - CMD-SHELL
        - test -f /mnt/backup/.mounted
      interval: 1m
      timeout: 5s
      retries: 3
      start_period: 15s

    labels:
      # ðŸ”¹ Traefik Integration
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.home`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls=true"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"


      - "com.centurylinklabs.watchtower.enable=true"
networks:
  proxy:
    external: true
